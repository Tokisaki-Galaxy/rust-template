#
# Description: Auto compile rust-template for multiple architectures
#
name: "Build rust-template"
on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  build:
    name: Build Multi-Arch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "${{ runner.os }}-section-cache-${{ hashFiles('**/Cargo.lock') }}"

      - name: Set version
        id: set_version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            # Tag trigger: use tag name as version (strip 'v' prefix)
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
            echo "Build triggered by Tag: Using Version=$VERSION"
          else
            # Non-tag trigger: use date + run_number + short SHA
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="0.0.0-dev.${{ github.run_number }}.g${SHORT_SHA}"
            echo "Build triggered by Commit: Using Version=$VERSION"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Inject version into Cargo.toml
          sed -i "s/^version = .*/version = \"${VERSION}\"/" Cargo.toml
          echo "Updated Cargo.toml version to: $VERSION"
          grep '^version' Cargo.toml

      - name: Install dependencies
        id: install_dependencies
        run: |
          chmod +x ./install_dependencies.sh
          sudo ./install_dependencies.sh
          df -H
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Build rust-template ${{ steps.set_version.outputs.version }}
        id: build
        if: steps.install_dependencies.outputs.status == 'success'
        run: |
          chmod +x ./build_release.sh
          sudo ./build_release.sh
          df -H
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Calculate Artifacts Size
              if: steps.build.outputs.status == 'success'
              run: |
                echo "=========================================="
                echo "ðŸ“¦ BUILD ARTIFACTS SUMMARY"
                echo "=========================================="
                printf "| %-50s | %-10s |\n" "File Name" "Size (KB)"
                printf "| %-50s | %-10s |\n" "--------------------------------------------------" "----------"

                cd release
                for file in *.tar.gz; do
                  if [ -f "$file" ]; then
                    SIZE=$(du -k "$file" | cut -f1)
                    printf "| %-50s | %8s KB |\n" "$file" "$SIZE"
                  fi
                done
                echo "=========================================="

      - name: Upload artifacts
        if: steps.build.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: release/*.tar.gz

      - name: Prepare release
        id: prepare_release
        if: startsWith(github.ref, 'refs/tags/v') && steps.build.outputs.status == 'success'
        run: |
          echo "![](https://img.shields.io/github/downloads/${{ github.repository }}/${{ github.ref_name }}/total?style=flat-square)" >> release.txt
          cd release
          echo "release_path=$PWD" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Publish Release
        if: steps.prepare_release.outputs.status == 'success'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          body_path: release.txt
          files: ${{ steps.prepare_release.outputs.release_path }}/*
