#
# Description: Auto compile rust-template for multiple architectures
#
name: "Build rust-template"
on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  build:
    name: Build Multi-Arch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: set_version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            # Tag trigger: use tag name as version (strip 'v' prefix)
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
            echo "Build triggered by Tag: Using Version=$VERSION"
          else
            # Non-tag trigger: use date + run_number + short SHA
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="0.0.0-dev.${{ github.run_number }}.g${SHORT_SHA}"
            echo "Build triggered by Commit: Using Version=$VERSION"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Inject version into Cargo.toml
          sed -i "s/^version = .*/version = \"${VERSION}\"/" Cargo.toml
          echo "Updated Cargo.toml version to: $VERSION"
          grep '^version' Cargo.toml

      - name: Install Rust nightly toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: >-
            x86_64-unknown-linux-musl,
            aarch64-unknown-linux-musl,
            armv7-unknown-linux-musleabihf,
            armv7-unknown-linux-musleabi,
            armv5te-unknown-linux-musleabi,
            arm-unknown-linux-musleabi,
            arm-unknown-linux-musleabihf,
            riscv64gc-unknown-linux-musl,
            powerpc64le-unknown-linux-musl

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}"

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: build-essential musl-tools pkg-config
          version: 1.0

      - name: Setup musl-cross directory
        run: |
          sudo mkdir -p /opt/musl-cross
          sudo chown "$(id -u):$(id -g)" /opt/musl-cross

      - name: Cache musl cross toolchains
        uses: actions/cache@v4
        with:
          path: /opt/musl-cross
          key: ${{ runner.os }}-musl-cross-v0.1.0

      - name: Install cross compilation toolchains
        run: |
          chmod +x ./install_dependencies.sh
          ./install_dependencies.sh

      - name: Build rust-template ${{ steps.set_version.outputs.version }}
        id: build
        run: |
          chmod +x ./build_release.sh
          ./build_release.sh
          df -H
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Calculate Artifacts Size
              if: steps.build.outputs.status == 'success'
              run: |
                echo "=========================================="
                echo "ðŸ“¦ BUILD ARTIFACTS SUMMARY"
                echo "=========================================="
                printf "| %-50s | %-10s |\n" "File Name" "Size (KB)"
                printf "| %-50s | %-10s |\n" "--------------------------------------------------" "----------"

                cd release
                for file in *.tar.gz; do
                  if [ -f "$file" ]; then
                    SIZE=$(du -k "$file" | cut -f1)
                    printf "| %-50s | %8s KB |\n" "$file" "$SIZE"
                  fi
                done
                echo "=========================================="

      - name: Upload artifacts
        if: steps.build.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: release/*.tar.gz

      - name: Prepare release
        id: prepare_release
        if: startsWith(github.ref, 'refs/tags/v') && steps.build.outputs.status == 'success'
        run: |
          echo "![](https://img.shields.io/github/downloads/${{ github.repository }}/${{ github.ref_name }}/total?style=flat-square)" >> release.txt
          cd release
          echo "release_path=$PWD" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Publish Release
        if: steps.prepare_release.outputs.status == 'success'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          body_path: release.txt
          files: ${{ steps.prepare_release.outputs.release_path }}/*
