#
# Description: Auto compile rust-template for multiple architectures using cross-rs
#
name: "Build rust-template"
on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai
  PROJECT_NAME: rust-template

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: set_version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            # Tag trigger: use tag name as version (strip 'v' prefix)
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
            echo "Build triggered by Tag: Using Version=$VERSION"
          else
            # Non-tag trigger: use date + run_number + short SHA
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="0.0.0-dev.${{ github.run_number }}.g${SHORT_SHA}"
            echo "Build triggered by Commit: Using Version=$VERSION"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

  build:
    name: Build ${{ matrix.target }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 architecture
          - target: x86_64-unknown-linux-musl
          # AArch64 (ARM64) architecture
          - target: aarch64-unknown-linux-musl
          # ARM 32-bit architecture
          - target: armv7-unknown-linux-musleabihf
          - target: armv7-unknown-linux-musleabi
          - target: armv5te-unknown-linux-musleabi
          - target: arm-unknown-linux-musleabi
          - target: arm-unknown-linux-musleabihf
          # RISC-V architecture
          - target: riscv64gc-unknown-linux-musl
          # PowerPC architecture
          - target: powerpc64le-unknown-linux-musl
          # MIPS 32-bit architectures (built with nightly + build-std)
          - target: mips-unknown-linux-musl
            use_nightly: true
          - target: mipsel-unknown-linux-musl
            use_nightly: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version in Cargo.toml
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          sed -i "s/^version = .*/version = \"${VERSION}\"/" Cargo.toml
          echo "Updated Cargo.toml version to: $VERSION"
          grep '^version' Cargo.toml

      - name: Install Rust stable toolchain
        if: ${{ !matrix.use_nightly }}
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust nightly toolchain
        if: ${{ matrix.use_nightly }}
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Install cross
        uses: taiki-e/install-action@cross

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "${{ runner.os }}-${{ matrix.target }}"

      - name: Build ${{ matrix.target }}
        run: |
          if [ "${{ matrix.use_nightly }}" = "true" ]; then
            cross +nightly build --release --target ${{ matrix.target }} -Z build-std
          else
            cross build --release --target ${{ matrix.target }}
          fi

      - name: Package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TARGET="${{ matrix.target }}"
          PACKAGE_DIR="${PROJECT_NAME}-${VERSION}-${TARGET}"

          mkdir -p "release/${PACKAGE_DIR}"
          cp "target/${TARGET}/release/${PROJECT_NAME}" "release/${PACKAGE_DIR}/"
          cp LICENSE "release/${PACKAGE_DIR}/" 2>/dev/null || true
          cp README.md "release/${PACKAGE_DIR}/" 2>/dev/null || true

          tar -czvf "release/${PROJECT_NAME}-${VERSION}-${TARGET}.tar.gz" -C release "${PACKAGE_DIR}"
          rm -rf "release/${PACKAGE_DIR}"

          echo "ðŸ“¦ Package: ${PROJECT_NAME}-${VERSION}-${TARGET}.tar.gz"
          ls -lh "release/${PROJECT_NAME}-${VERSION}-${TARGET}.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.target }}
          path: release/*.tar.gz

  release:
    name: Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: ${{ env.PROJECT_NAME }}-*
          merge-multiple: true

      - name: Calculate Artifacts Size
        run: |
          echo "=========================================="
          echo "ðŸ“¦ BUILD ARTIFACTS SUMMARY"
          echo "=========================================="
          printf "| %-60s | %-10s |\n" "File Name" "Size (KB)"
          printf "| %-60s | %-10s |\n" "------------------------------------------------------------" "----------"
          for file in release/*.tar.gz; do
            if [ -f "$file" ]; then
              SIZE=$(du -k "$file" | cut -f1)
              printf "| %-60s | %8s KB |\n" "$(basename "$file")" "$SIZE"
            fi
          done
          echo "=========================================="

      - name: Prepare release notes
        run: |
          echo "![](https://img.shields.io/github/downloads/${{ github.repository }}/${{ github.ref_name }}/total?style=flat-square)" >> release.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          body_path: release.txt
          files: release/*
